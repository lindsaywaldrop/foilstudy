---
title: "R Notebook for gPC expansion"
output:
  html_document:
    df_print: paged
  html_notebook: default
  pdf_document: default
---

```{r setup}
library(pracma)
library(spacefillr)
library(ggplot2)
library(patchwork)
```

Based on Nick Battista's MATLAB code. 

Load custom functions: 

```{r}
source("./src/r-scripts/gPC_functions.R")
source("./src/r-scripts/gpc_user_specified_model.R")
```

Initial parameters: 

```{r initial-parameters}
test_flag <- 1
```

Set gPC parameters:

```{r set-gpc-parameters}
n <- 3
p <- 6
cap_p <- nchoosek(n + p, p)
```

Find collocation points:

```{r collocation-points}
poly_roots <- Legendre_roots(p + 1, test_flag)
```

Find combinations of all collocation points: 

```{r}
param_combo <- compute_all_collo_pt_combos(n, poly_roots, test_flag)
```

Get subset of all parameter combinations for least squares: 

```{r}
n_subset <- 1 * (n - 1) * cap_p
param_combo_subset <- sample_parameter_combos(n_subset, param_combo, test_flag)
```

Multivaribale Lengendre polynomial ordering:

```{r}
alpha_mat <- create_polynomial_ordering(n, p, test_flag)
```

Create information matrix: 

```{r}
info_mat <- create_info_matrix(n, p, cap_p, param_combo_subset, alpha_mat, test_flag)
```

Evaluate user-specified model for particular parameter combos:

```{r}
Y <- rep(0, nrow(param_combo_subset))
for(i in 1:nrow(param_combo_subset)){
  Y[i] <- user_specified_model(param_combo_subset[i, ])
}

# testing against matlab values:
if(test_flag == 1){
  matlab_Y <- read.csv("./test/gpc_matlab/Y.csv", header = F)
  all.equal(Y, matlab_Y[, 1])
}
```

Solve for coefficients via least-squares with SVD:

```{r}
temp_mat <- t(info_mat) %*% info_mat
S <- svd(temp_mat)
sigma <- diag(S$d, cap_p, cap_p)

# testing against matlab values:
if(test_flag == 1){
  matlab_sigma <- as.matrix(read.csv("./test/gpc_matlab/sigma.csv", header = F))
  all.equal(sigma, matlab_sigma, check.attributes = F)
}

s_coeffs <- S$v %*% solve(sigma) %*% Conj(t.default(S$u)) %*% t(info_mat) %*% Y

# testing against matlab values:
if(test_flag == 1){
  matlab_sCoeffs <- as.matrix(read.csv("./test/gpc_matlab/s_coeffs.csv", header = F))
  all.equal(s_coeffs, matlab_sCoeffs, check.attributes = F)
}
```

Compute errors between gPC surrogate and true model function:

```{r}
sobol_seed <- 14
test_errors <- compute_validation_and_testing_error(n, s_coeffs, alpha_mat, 
                                     param_combo_subset, sobol_seed)
```

Report results:

```{r echo = FALSE}
err_rel_train <- abs(test_errors$training$gpc_dat - test_errors$training$real_dat) / abs(test_errors$training$real_dat) * 100
print("~*~._.~*~ Training set ~*~._.~*~")
print(paste("median error:", round(median(err_rel_train, na.rm = T), digits = 2)))
print(paste(c("min error:", "max error:"), round(range(err_rel_train), digits = 2)))
print(paste("standard deviation:", round(sd(err_rel_train, na.rm = T),digits = 2)))

err_rel_test <- abs(test_errors$testing$gpc_dat - test_errors$testing$real_dat) / abs(test_errors$testing$real_dat) * 100
print("~*~._.~*~ Testing set ~*~._.~*~");
print(paste("median error:", round(median(err_rel_test, na.rm = T), digits = 2)))
print(paste(c("min error:", "max error:"), round(range(err_rel_test), digits = 2)))
print(paste("standard deviation:", round(sd(err_rel_test, na.rm = T), digits = 2)))
```

Testing expansion on 2D subspace:

```{r}
plots <- test_gpc_expansion(s_coeffs, alpha_mat)

plots[[1]] + plots[[2]] + plot_layout(guides = "collect")
```

Compute the Sobol indices: 

```{r}
sobols <- compute_sobol_indices(s_coeffs, alpha_mat)
```

Report Sobol Indices:

```{r echo=F}
print("~*~._.~*~ 1st order Sobol Indices ~*~._.~*~")
print(paste0("s", 1:3, ": ", round(sobols[["s_first"]], digits = 4)))
print("~*~._.~*~ 2nd order Sobol Indices ~*~._.~*~")
print(paste0("s", c(12, 13, 23), ": ", round(sobols[["s2nd"]][!is.na(sobols[["s2nd"]])], 
                                             digits = 4)))
print("~*~._.~*~ s123 Sobol index ~*~._.~*~")
print(round(sobols[["s123"]][1], digits = 4))
print("~*~._.~*~ Total-order Sobol indices ~*~._.~*~")
print(paste0("sT", 1:3, ": ", round(sobols[["s_total"]], digits = 4)))
```
