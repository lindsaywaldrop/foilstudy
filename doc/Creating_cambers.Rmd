---
title: "Creating Cambers Notebook"
output: html_notebook
---

# Foil Study -- Creating Cambers

This notebook will guide you through creating the necessary airfoils to run the foil study. It uses the R scripts found in ./src/r-scripts and the parameter list of cambers in ./data/camber_list.csv to alter the NACA airfoil ./data/AS6091.csv to produce airfoils with different cambers, the output will be located in ./data/. 

Please ensure that the notebook is being knitted through the project directory: select the drop down arrow next to "Preview" and then "Knit Directory" and "Project Directory."

```{r}
# functions
calc_camber <- function(x, y, check = NULL){
  camber <- (max(y) - min(y)) / (max(x) - min(x))
  if(!is.null(check)){
    return(all.equal(camber, check))
  }else{
   return(camber) 
  }
}

mag <- function(x) {
  return(sqrt((x[1])^2 + (x[2])^2))
}

dist <- function(x1, x2, y1, y2) {
  return(sqrt((x2 - x1)^2 + (y2 - y1)^2))
}

calc_angle <- function(p1, p2, p3){
  a <- c(p3[1] - p2[1], p3[2] - p2[2])
  b <- c(p1[1] - p2[1], p1[2] - p2[2])
  alpha <- acos((a[1]*b[1] + a[2]*b[2]) / (mag(a) * mag(b)))
  return(alpha)
}

correct_2D_pts <- function(pts, center_pt, alpha){
  rotm <- matrix(c(cos(alpha), sin(alpha), -sin(alpha), cos(alpha)), ncol = 2)
  if(!is.matrix(pts)) pts <- as.matrix(pts)
  rot_pts <- t(rotm %*% ( t(pts) - c(center_pt[1], center_pt[2])) + 
                 c(center_pt[1], center_pt[2]))
  corr_pts <- rot_pts
  corr_pts[,1] <- rot_pts[,1] - (center_pt[1])
  corr_pts[,2] <- rot_pts[,2] - (center_pt[2])
  return(corr_pts)
}

find_midline <- function(x, y, smoothed = TRUE, plot = TRUE){
  npts <- length(x)
  foil_midline_x <- rep(NA, npts/2)
  foil_midline_y <- rep(NA, npts/2)
  thickness_top_x <- rep(NA, npts/2)
  thickness_top_y <- rep(NA, npts/2)
  thickness_bot_x <- rep(NA, npts/2)
  thickness_bot_y <- rep(NA, npts/2)
  for(i in 1:(npts/2)){
    foil_midline_x[i] <- (x[i] - x[(npts + 1) - i])/2 + 
                          x[(npts + 1) - i]
    foil_midline_y[i] <- (y[i] - y[(npts + 1) - i])/2 + 
                          y[(npts + 1) - i]
  }
  for(i in 1:(npts/2)){
    thickness_top_x[i] <- (foil_midline_x[i] - x[i])
    thickness_top_y[i] <- (foil_midline_y[i] - y[i])
    thickness_bot_x[i] <- (foil_midline_x[i] - 
                             x[(npts + 1) - i])
    thickness_bot_y[i] <- (foil_midline_y[i] - 
                             y[(npts + 1) - i])
  } 
  if(smoothed) {
    loess_sm <- loess(foil_midline_y ~ foil_midline_x, span = 0.5, parametric = "span")
    foil_midline_y <- predict(loess_sm, foil_midline_x)
  }
  
  if(plot){
    plot(x, y, type = "o", asp = 1, col = viridis::viridis(npts))
    lines(c(-10, 10), c(0, 0), lty = 2)
    points(foil_midline_x, foil_midline_y, col = viridis::viridis(npts/2, option = "A"))
    for(i in 1:(npts/2)) {
      lines(x = c(x[i], x[(npts + 1) - i]), 
                     y = c(y[i], y[(npts + 1) - i]))
      lines(x = c(foil_midline_x[i], foil_midline_x[i] + thickness_top_x[i]), 
            y = c(foil_midline_y[i], foil_midline_y[i] + thickness_top_y[i]), 
            col = "red")
      lines(x = c(foil_midline_x[i], foil_midline_x[i] + thickness_bot_x[i]), 
            y = c(foil_midline_y[i], foil_midline_y[i] + thickness_bot_y[i]), 
            col = "blue")
    }
  }
  foil_midline <- data.frame("x" = foil_midline_x, "y" = foil_midline_y, 
                             "thickness_top_x" = thickness_top_x, 
                             "thickness_top_y" = thickness_top_y, 
                             "thickness_bot_x" = thickness_bot_x, 
                             "thickness_bot_y" = thickness_bot_y)
  return(foil_midline)
}

```

Define new camber: 

```{r}
camber_new <- 0.01
```

Load airfoil: 

```{r}
foil <- read.table("./data/AS6091.dat", skip = 0)
colnames(foil) <- c("x", "y")
npts <- nrow(foil)
plot(y~x, data = foil, type = "o", asp = 1, col = viridis::viridis(npts))
for(i in 1:80) lines(x = c(foil$x[i], foil$x[(npts + 1) - i]), 
                     y = c(foil$y[i], foil$y[(npts + 1) - i]))
```

Calculate midline: 
```{r}
foil_midline_sm <- find_midline(foil$x, foil$y)
```
Calculate original camber: 

```{r}
calc_camber(foil_midline_sm$x, foil_midline_sm$y)
```

Create new midline: 
```{r}
new_midline <- foil_midline
new_midline$y <- ((foil_midline$y - min(foil_midline$y)) * camber_new ) / (max(foil_midline$y) - min(foil_midline$y))
plot(foil_midline$x, foil_midline$y, asp = 1, col = viridis::viridis(80))
points(new_midline$x, new_midline$y)

```

Create new foil based on midline and thicknesses: 

```{r}
new_foil <- data.frame("x" = rep(NA, 160), "y" = rep(NA, 160))

new_foil$x[1:80] <- new_midline$x - new_midline$thickness_top_x
new_foil$y[1:80] <- new_midline$y - new_midline$thickness_top_y
new_foil$x[160:81] <- new_midline$x - new_midline$thickness_bot_x
new_foil$y[160:81] <- new_midline$y - new_midline$thickness_bot_y
plot(new_foil$x, new_foil$y, asp = 1)
points(new_midline$x, new_midline$y, col = viridis::viridis(80))
lines(c(0,1), c(0,0), lty = 2)
for(i in 1:80){
  lines(x = c(new_midline$x[i], new_midline$x[i] - new_midline$thickness_top_x[i]), 
            y = c(new_midline$y[i], new_midline$y[i] - new_midline$thickness_top_y[i]), 
            col = "red")
  lines(x = c(new_midline$x[i], 
              new_midline$x[i] - new_midline$thickness_bot_x[i]), 
            y = c(new_midline$y[i], 
                  new_midline$y[i] - new_midline$thickness_bot_y[i]), 
            col = "blue")
}
```



Calculate new camber and create new midline: 

```{r}
calc_camber(ASnew$x, ASnew$y)
new_midline_sm <- find_midline(ASnew$x, ASnew$y, plot = T)
```

Realign foil: 

```{r}
num1 <- which(new_midline_sm == min(new_midline_sm))
num2 <- ifelse(num1 == 1, 80, 1)
new_midline_adj <- new_midline_sm - new_midline_sm[num1]
p1 <- c(foil$x[num2], new_midline_adj[num2])
p2 <- c(foil$x[num1], new_midline_adj[num1])
p3 <- c(0, 0)
alpha <- calc_angle(p1, p2, p3)
new_midline <- correct_2D_pts(data.frame(foil$x[1:80],new_midline_adj), p2, alpha)
new_midline <- as.data.frame(new_midline)
colnames(new_midline) <- c("x", "y")
new_midline$x <- new_midline$x + 1
plot(foil$x[1:80], new_midline_sm, type = "l")
lines(foil$x[1:80],  new_midline_adj, col = "red")
lines(c(0, 1), c(0, 0), lty = 3)
points(p1[1], p1[2])
points(p2[1], p2[2], pch = 19)
points(p3[1], p3[2], pch = 19)
points(new_midline$x, new_midline$y)
```


Check new camber against specified value:

```{r}
calc_camber(ASnew$x, ASnew$y, camber_new)
```


Write new foil to a file:

```{r}
write.csv(new_foil, file = "./data/ASnew.csv", row.names = F)
```


### Produce all airfoil files

Please run the following script: 
```{r}
#source("./src/r-scripts/calculate_cambers.R", echo = F)
```